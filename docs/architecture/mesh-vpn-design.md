# Distributed Mesh VPN Architecture for wg-quickrs

> **Status**: Design Document / Future Roadmap  
> **Author**: AI-assisted design  
> **Date**: December 2025

## Overview

This document describes the architecture for evolving wg-quickrs from a hub-and-spoke model to a **full mesh network** similar to Tailscale/Headscale.

---

## ğŸ—ï¸ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           COORDINATION LAYER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    Coordination Server (API)                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚    â”‚
â”‚  â”‚  â”‚   Endpoint   â”‚  â”‚    Peer      â”‚  â”‚   Access     â”‚               â”‚    â”‚
â”‚  â”‚  â”‚   Registry   â”‚  â”‚  Directory   â”‚  â”‚   Control    â”‚               â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AGENT LAYER                                     â”‚
â”‚                                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚  wg-quickrs     â”‚   â”‚  wg-quickrs     â”‚   â”‚  wg-quickrs     â”‚          â”‚
â”‚   â”‚  Agent (VPS)    â”‚   â”‚  Agent (Home)   â”‚   â”‚  Agent (Mobile) â”‚          â”‚
â”‚   â”‚                 â”‚   â”‚                 â”‚   â”‚                 â”‚          â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
â”‚   â”‚ â”‚ WireGuard   â”‚ â”‚   â”‚ â”‚ WireGuard   â”‚ â”‚   â”‚ â”‚ WireGuard   â”‚ â”‚          â”‚
â”‚   â”‚ â”‚ Interface   â”‚ â”‚   â”‚ â”‚ Interface   â”‚ â”‚   â”‚ â”‚ Interface   â”‚ â”‚          â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
â”‚   â”‚ â”‚ Mesh Agent  â”‚â—„â”¼â”€â”€â”€â”¼â–ºâ”‚ Mesh Agent  â”‚â—„â”¼â”€â”€â”€â”¼â–ºâ”‚ Mesh Agent  â”‚ â”‚          â”‚
â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚           â”‚                     â”‚                     â”‚                     â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                    Direct P2P Tunnels (when possible)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              RELAY LAYER                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Relay Servers (DERP-like)                         â”‚   â”‚
â”‚   â”‚         Fallback when direct P2P connection fails                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Component Breakdown

### 1. Coordination Server

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COORDINATION SERVER                           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                      REST API                               â”‚ â”‚
â”‚  â”‚  POST /agents/register     - Register new agent             â”‚ â”‚
â”‚  â”‚  PUT  /agents/:id/endpoint - Update endpoint                â”‚ â”‚
â”‚  â”‚  GET  /agents/:id/peers    - Get peer list with endpoints   â”‚ â”‚
â”‚  â”‚  POST /agents/:id/heartbeat - Keep-alive                    â”‚ â”‚
â”‚  â”‚  WS   /agents/:id/sync     - Real-time updates              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Endpoint Registryâ”‚  â”‚ Peer Directory   â”‚  â”‚ ACL Manager    â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                â”‚ â”‚
â”‚  â”‚ agent_id: {      â”‚  â”‚ network_id: {    â”‚  â”‚ policies: [    â”‚ â”‚
â”‚  â”‚   public_key,    â”‚  â”‚   agents: [...], â”‚  â”‚   {from, to,   â”‚ â”‚
â”‚  â”‚   endpoint,      â”‚  â”‚   subnets: [...],â”‚  â”‚    allow}      â”‚ â”‚
â”‚  â”‚   last_seen,     â”‚  â”‚   routes: [...]  â”‚  â”‚ ]              â”‚ â”‚
â”‚  â”‚   nat_type       â”‚  â”‚ }                â”‚  â”‚                â”‚ â”‚
â”‚  â”‚ }                â”‚  â”‚                  â”‚  â”‚                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    Database (SQLite/Postgres)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Mesh Agent (extends current wg-quickrs)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    wg-quickrs MESH AGENT                         â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              EXISTING wg-quickrs CORE                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ WireGuard    â”‚  â”‚ Router Mode  â”‚  â”‚ Firewall Manager â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ Manager      â”‚  â”‚ (PBR, Exit)  â”‚  â”‚ (iptables)       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚ Health       â”‚  â”‚ Peer Manager â”‚  â”‚ Web UI           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚ Monitor      â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              NEW MESH COMPONENTS                            â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  â”‚ Endpoint         â”‚  â”‚ Coordination     â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ Discovery        â”‚  â”‚ Client           â”‚                â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚                  â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - STUN client    â”‚  â”‚ - Register       â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - NAT detection  â”‚  â”‚ - Heartbeat      â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - Port mapping   â”‚  â”‚ - Sync peers     â”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚ â”‚
â”‚  â”‚  â”‚ Direct Connect   â”‚  â”‚ Relay Client     â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ Manager          â”‚  â”‚                  â”‚                â”‚ â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚ - DERP protocol  â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - Hole punching  â”‚  â”‚ - Fallback path  â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - Path selection â”‚  â”‚ - Encrypted      â”‚                â”‚ â”‚
â”‚  â”‚  â”‚ - Latency probe  â”‚  â”‚                  â”‚                â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Connection Flows

### Phase 1: Agent Registration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent A    â”‚                              â”‚  Coordination    â”‚
â”‚  (Starting)  â”‚                              â”‚     Server       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                               â”‚
       â”‚  1. Discover my public endpoint (STUN)        â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
       â”‚                                               â”‚
       â”‚  2. POST /agents/register                     â”‚
       â”‚  {                                            â”‚
       â”‚    public_key: "...",                         â”‚
       â”‚    endpoint: "203.0.113.5:51820",             â”‚
       â”‚    nat_type: "full_cone",                     â”‚
       â”‚    capabilities: ["router", "exit_node"],    â”‚
       â”‚    advertised_routes: ["192.168.1.0/24"]     â”‚
       â”‚  }                                            â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                                               â”‚
       â”‚  3. Response: agent_id, auth_token            â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚                                               â”‚
       â”‚  4. WebSocket /agents/:id/sync                â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚     (bi-directional real-time updates)        â”‚
       â”‚                                               â”‚
```

### Phase 2: Peer Discovery & Direct Connection

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent A    â”‚          â”‚   Coordination   â”‚          â”‚   Agent B    â”‚
â”‚  (VPS)       â”‚          â”‚      Server      â”‚          â”‚  (Home)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚                           â”‚
       â”‚  1. Request peers         â”‚                           â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                           â”‚
       â”‚                           â”‚                           â”‚
       â”‚  2. Peer list (B's info)  â”‚                           â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
       â”‚  {                        â”‚                           â”‚
       â”‚    peer: "B",             â”‚                           â”‚
       â”‚    endpoint: "...:51820", â”‚                           â”‚
       â”‚    nat_type: "symmetric", â”‚                           â”‚
       â”‚    routes: ["192.168.1.0/24"]                         â”‚
       â”‚  }                        â”‚                           â”‚
       â”‚                           â”‚                           â”‚
       â”‚  3. Attempt direct connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚     (UDP hole punch)      â”‚                           â”‚
       â”‚                           â”‚                           â”‚
       â”‚  4a. SUCCESS: Direct P2P established â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚      - Update WireGuard peer endpoint                 â”‚
       â”‚      - wg set wg0 peer <B_pubkey> endpoint <B_endpoint>
       â”‚                           â”‚                           â”‚
       â”‚  4b. FAIL: Use relay â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚            (see Phase 3)  â”‚                           â”‚
       â”‚                           â”‚                           â”‚
```

### Phase 3: Relay Fallback (DERP-like)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Agent A    â”‚          â”‚   Relay Server   â”‚          â”‚   Agent B    â”‚
â”‚  (Mobile)    â”‚          â”‚   (DERP-like)    â”‚          â”‚  (Symmetric  â”‚
â”‚              â”‚          â”‚                  â”‚          â”‚   NAT)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚                           â”‚
       â”‚  Direct connection failed â”‚                           â”‚
       â”‚  (symmetric NAT on both)  â”‚                           â”‚
       â”‚                           â”‚                           â”‚
       â”‚  1. Connect to relay      â”‚  1. Connect to relay      â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚  (persistent WebSocket)   â”‚  (persistent WebSocket)   â”‚
       â”‚                           â”‚                           â”‚
       â”‚  2. Send encrypted WG     â”‚                           â”‚
       â”‚     packets via relay     â”‚                           â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  3. Forward to Agent B    â”‚
       â”‚                           â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
       â”‚                           â”‚                           â”‚
       â”‚  4. Response via relay    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                           â”‚
       â”‚                           â”‚                           â”‚
       â”‚  (Packets are WireGuard encrypted - relay can't read) â”‚
       â”‚                           â”‚                           â”‚
```

---

## ğŸ“ Proposed File Structure

```
src/wg-quickrs/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ lib.rs
â”‚   â”œâ”€â”€ config.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ wireguard/              # Existing
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ interface.rs
â”‚   â”‚   â””â”€â”€ peers.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ mode/                   # Existing (Router Mode)
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ mode.rs
â”‚   â”‚   â”œâ”€â”€ routing_pbr.rs
â”‚   â”‚   â””â”€â”€ persist.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ firewall.rs             # Existing
â”‚   â”œâ”€â”€ helpers.rs              # Existing
â”‚   â”‚
â”‚   â””â”€â”€ mesh/                   # NEW - Mesh Components
â”‚       â”œâ”€â”€ mod.rs
â”‚       â”œâ”€â”€ endpoint_discovery.rs    # STUN, NAT detection
â”‚       â”œâ”€â”€ coordination_client.rs   # API client for coord server
â”‚       â”œâ”€â”€ peer_sync.rs             # Sync peer endpoints
â”‚       â”œâ”€â”€ direct_connect.rs        # Hole punching, path selection
â”‚       â”œâ”€â”€ relay_client.rs          # DERP-like relay fallback
â”‚       â””â”€â”€ mesh_state.rs            # Mesh-specific persistence
â”‚
â”œâ”€â”€ Cargo.toml

src/wg-quickrs-coordinator/          # NEW - Coordination Server
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ agents.rs
â”‚   â”‚   â”œâ”€â”€ networks.rs
â”‚   â”‚   â””â”€â”€ websocket.rs
â”‚   â”œâ”€â”€ registry/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ endpoints.rs
â”‚   â”‚   â””â”€â”€ peers.rs
â”‚   â”œâ”€â”€ acl/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ policies.rs
â”‚   â””â”€â”€ db/
â”‚       â”œâ”€â”€ mod.rs
â”‚       â””â”€â”€ models.rs
â”‚
â”œâ”€â”€ Cargo.toml

src/wg-quickrs-relay/                # NEW - Relay Server
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs
â”‚   â”œâ”€â”€ derp_protocol.rs
â”‚   â”œâ”€â”€ client_handler.rs
â”‚   â””â”€â”€ packet_router.rs
â”‚
â”œâ”€â”€ Cargo.toml
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SECURITY LAYERS                               â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Layer 1: Agent Authentication                               â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Agent â”€â”€â–º Coordination Server                              â”‚ â”‚
â”‚  â”‚  - WireGuard public key as identity                         â”‚ â”‚
â”‚  â”‚  - Signed registration request (prove key ownership)        â”‚ â”‚
â”‚  â”‚  - JWT token for subsequent API calls                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Layer 2: Network Authorization                              â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Networks (groups of agents with shared access)             â”‚ â”‚
â”‚  â”‚  - Agent A can only see peers in same network               â”‚ â”‚
â”‚  â”‚  - ACL policies control which peers can connect             â”‚ â”‚
â”‚  â”‚  - Route advertisements filtered by policy                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Layer 3: Transport Encryption                               â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  All traffic WireGuard encrypted end-to-end                 â”‚ â”‚
â”‚  â”‚  - Relay servers cannot decrypt traffic                     â”‚ â”‚
â”‚  â”‚  - Coordination server never sees traffic                   â”‚ â”‚
â”‚  â”‚  - Only metadata (endpoints) visible to infrastructure      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Layer 4: Key Exchange (Optional - for auto peer setup)     â”‚ â”‚
â”‚  â”‚                                                             â”‚ â”‚
â”‚  â”‚  Pre-shared keys or Noise protocol for initial handshake   â”‚ â”‚
â”‚  â”‚  - Avoid manual key distribution                            â”‚ â”‚
â”‚  â”‚  - Coordination server as key broker (encrypted)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Models

### Coordination Server Database Schema

```sql
-- Agents table
CREATE TABLE agents (
    id UUID PRIMARY KEY,
    public_key TEXT UNIQUE NOT NULL,
    name TEXT,
    endpoint TEXT,                    -- Current public IP:port
    endpoint_updated_at TIMESTAMP,
    nat_type TEXT,                    -- full_cone, restricted, symmetric
    capabilities TEXT[],              -- ['router', 'exit_node', 'relay']
    last_seen TIMESTAMP,
    created_at TIMESTAMP
);

-- Networks (logical groupings)
CREATE TABLE networks (
    id UUID PRIMARY KEY,
    name TEXT NOT NULL,
    cidr TEXT NOT NULL,               -- e.g., "10.8.0.0/24"
    created_at TIMESTAMP
);

-- Agent network membership
CREATE TABLE agent_networks (
    agent_id UUID REFERENCES agents(id),
    network_id UUID REFERENCES networks(id),
    tunnel_ip TEXT NOT NULL,          -- e.g., "10.8.0.1"
    PRIMARY KEY (agent_id, network_id)
);

-- Advertised routes
CREATE TABLE routes (
    id UUID PRIMARY KEY,
    agent_id UUID REFERENCES agents(id),
    network_id UUID REFERENCES networks(id),
    cidr TEXT NOT NULL,               -- e.g., "192.168.1.0/24"
    is_exit_route BOOLEAN DEFAULT FALSE
);

-- Access policies
CREATE TABLE policies (
    id UUID PRIMARY KEY,
    network_id UUID REFERENCES networks(id),
    source_agent_id UUID,             -- NULL = any
    dest_agent_id UUID,               -- NULL = any
    dest_cidr TEXT,                   -- NULL = any
    action TEXT NOT NULL,             -- 'allow' or 'deny'
    priority INT
);
```

---

## ğŸ”„ Endpoint Discovery Protocol

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ENDPOINT DISCOVERY FLOW                           â”‚
â”‚                                                                  â”‚
â”‚  1. STUN Query (determine public IP:port)                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”‚  Agent  â”‚â”€â”€STUNâ”€â”€â”€â–ºâ”‚ STUN Server â”‚                        â”‚
â”‚     â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (public)    â”‚                        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚     Response: "Your public endpoint is 203.0.113.5:51820"       â”‚
â”‚                                                                  â”‚
â”‚  2. NAT Type Detection                                          â”‚
â”‚     - Full Cone: Any external host can send to mapped port      â”‚
â”‚     - Restricted: Only hosts we've sent to can reply            â”‚
â”‚     - Port Restricted: Only same host:port can reply            â”‚
â”‚     - Symmetric: Different mapping for each destination         â”‚
â”‚                                                                  â”‚
â”‚  3. UPnP/NAT-PMP (optional port mapping)                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚     â”‚  Agent  â”‚â”€â”€UPnPâ”€â”€â”€â–ºâ”‚   Router    â”‚                        â”‚
â”‚     â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚                        â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚     Request: "Map external port 51820 to internal 51820"        â”‚
â”‚                                                                  â”‚
â”‚  4. Report to Coordination Server                               â”‚
â”‚     {                                                           â”‚
â”‚       "endpoint": "203.0.113.5:51820",                          â”‚
â”‚       "nat_type": "restricted_cone",                            â”‚
â”‚       "upnp_mapped": true,                                      â”‚
â”‚       "local_endpoint": "192.168.1.100:51820"                   â”‚
â”‚     }                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ NAT Traversal Decision Tree

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Want to connect     â”‚
                    â”‚ Agent A â”€â”€â–º Agent B â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Both have public IP â”‚
                    â”‚ (no NAT)?           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ YES                             â”‚ NO
              â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Direct connect  â”‚              â”‚ Check NAT types     â”‚
    â”‚ (easy mode)     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â–¼                       â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ At least one    â”‚    â”‚ Both symmetric  â”‚
                          â”‚ has full/       â”‚    â”‚ NAT?            â”‚
                          â”‚ restricted cone â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
                                   â”‚                      â”‚
                                   â–¼                      â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ UDP Hole Punch  â”‚    â”‚ RELAY REQUIRED  â”‚
                          â”‚ (usually works) â”‚    â”‚ (no direct path)â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Implementation Phases

### Phase 1: Coordination Server MVP (Week 1-2)

| Task | Description |
|------|-------------|
| REST API | Basic endpoints (register, heartbeat, peer list) |
| Database | SQLite for simplicity, migration to Postgres later |
| Auth | JWT-based authentication |
| WebSocket | Real-time peer updates |

### Phase 2: Agent Mesh Module (Week 3-4)

| Task | Description |
|------|-------------|
| STUN Client | Endpoint discovery using public STUN servers |
| Coordination Client | API client for coord server |
| Auto-update | Automatically update WireGuard peer endpoints |
| NAT Detection | Determine NAT type for connection decisions |

### Phase 3: Direct Connection (Week 5-6)

| Task | Description |
|------|-------------|
| Hole Punching | UDP hole punch implementation |
| Timeouts | Connection attempt with graceful timeout |
| Path Selection | Latency-based optimal path selection |
| Fallback Logic | Trigger relay when direct fails |

### Phase 4: Relay Server (Week 7-8)

| Task | Description |
|------|-------------|
| DERP Protocol | Tailscale-compatible relay protocol |
| Packet Forwarding | WebSocket-based encrypted packet relay |
| Multi-region | Support for geographically distributed relays |
| Auto-selection | Latency-based relay selection |

### Phase 5: Web UI Integration (Week 9-10)

| Task | Description |
|------|-------------|
| Mesh Dashboard | Status overview of mesh network |
| Peer Visualization | Visual representation of peer connections |
| Topology Map | Network topology visualization |
| Manual Controls | Override automatic decisions |

---

## ğŸ“ˆ Comparison: Current vs Mesh Architecture

| Aspect | Current wg-quickrs | With Mesh |
|--------|-------------------|-----------|
| **Topology** | Hub-and-spoke | Full mesh |
| **Endpoint Config** | Manual/static | Automatic discovery |
| **Roaming** | Manual update | Seamless |
| **NAT Traversal** | User problem | Automatic |
| **Latency** | Via hub | Direct P2P |
| **Resilience** | Hub = SPOF | Distributed |
| **Scaling** | Hub bottleneck | O(1) per peer |
| **Setup** | Per-peer config | Join network |

---

## ğŸ”§ Key Rust Crates

| Crate | Purpose |
|-------|---------|
| `tokio` | Async runtime |
| `axum` | Web framework for coordination server |
| `sqlx` | Database access |
| `jsonwebtoken` | JWT authentication |
| `tokio-tungstenite` | WebSocket support |
| `stun-rs` | STUN protocol implementation |
| `socket2` | Low-level socket control for hole punching |

---

## ğŸ“‹ API Specification

### Agent Registration

```http
POST /api/v1/agents/register
Content-Type: application/json

{
  "public_key": "base64_encoded_wg_public_key",
  "name": "home-router",
  "endpoint": "203.0.113.5:51820",
  "nat_type": "restricted_cone",
  "capabilities": ["router", "exit_node"],
  "advertised_routes": ["192.168.1.0/24"]
}

Response:
{
  "agent_id": "uuid",
  "token": "jwt_token",
  "network_id": "uuid"
}
```

### Get Peers

```http
GET /api/v1/agents/{agent_id}/peers
Authorization: Bearer {token}

Response:
{
  "peers": [
    {
      "agent_id": "uuid",
      "public_key": "base64_encoded",
      "name": "vps-gateway",
      "endpoint": "198.51.100.10:51820",
      "nat_type": "none",
      "routes": ["0.0.0.0/0"],
      "last_seen": "2025-12-05T10:30:00Z",
      "connection_hint": "direct"
    }
  ]
}
```

### Heartbeat

```http
POST /api/v1/agents/{agent_id}/heartbeat
Authorization: Bearer {token}
Content-Type: application/json

{
  "endpoint": "203.0.113.5:51820",  // May have changed
  "peer_status": {
    "uuid1": {"connected": true, "latency_ms": 15},
    "uuid2": {"connected": false}
  }
}
```

---

## ğŸ”® Future Considerations

1. **MagicDNS**: Automatic DNS for peers (peer.network.local)
2. **Subnet Routers**: Advertise entire subnets through specific peers
3. **Exit Nodes**: Mark peers as internet exit points
4. **ACL Policies**: Fine-grained access control between peers
5. **Multi-user**: Support for organizations with user management
6. **Mobile Apps**: Native iOS/Android apps with mesh support

---

## References

- [Tailscale Architecture](https://tailscale.com/blog/how-tailscale-works/)
- [WireGuard Protocol](https://www.wireguard.com/protocol/)
- [STUN RFC 5389](https://datatracker.ietf.org/doc/html/rfc5389)
- [NAT Traversal Techniques](https://bford.info/pub/net/p2pnat/)

